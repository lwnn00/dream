<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¶³çƒè®©çƒ/å¤§å°ç›˜å£è®°å½•è½¯ä»¶</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* æ ·å¼éƒ¨åˆ†ä¿æŒä¸å˜ï¼Œä¸åŸå§‹ä»£ç ç›¸åŒ */
        .handicap-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eaeaea;
        }

        .handicap-tab {
            flex: 1;
            padding: 12px 16px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px 8px 0 0;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 4px;
            color: #666;
        }

        .handicap-tab.active {
            background: #2a5298;
            color: white;
        }

        .handicap-tab:last-child {
            margin-right: 0;
        }

        .handicap-content {
            display: none;
        }

        .handicap-content.active {
            display: block;
        }

        .size-recommendation-up {
            color: #28a745;
            background-color: rgba(40, 167, 69, 0.08);
            border: 2px solid #28a745;
        }

        .size-recommendation-down {
            color: #dc3545;
            background-color: rgba(220, 53, 69, 0.08);
            border: 2px solid #dc3545;
        }

        .size-recommendation-neutral {
            color: #6c757d;
            background-color: rgba(108, 117, 125, 0.08);
            border: 2px solid #6c757d;
        }

        .recommendation-label {
            font-size: 16px;
            color: #666;
            margin-bottom: 10px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .recommendation-label i {
            margin-right: 8px;
            font-size: 18px;
        }

        .dual-recommendation {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .recommendation-box {
            flex: 1;
            background-color: white;
            border-radius: 10px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        /* è°ƒæ•´å†å²è¡¨æ ¼åˆ—å®½ */
        .history-table th:nth-child(1) {
            width: 120px;
        }

        .history-table th:nth-child(2) {
            width: 80px;
        }

        .history-table th:nth-child(3) {
            width: 100px;
        }

        /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ï¼Œåªæ·»åŠ æ–°å¢éƒ¨åˆ† */
        .user-section {
            position: absolute;
            top: 16px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info {
            color: white;
            font-size: 14px;
            text-align: right;
        }

        .user-name {
            font-weight: 600;
        }

        .user-type {
            font-size: 12px;
            opacity: 0.85;
        }

        .user-actions {
            display: flex;
            gap: 6px;
        }

        .user-btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .user-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            width: 90%;
            max-width: 400px;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            color: #1e3c72;
            margin: 0 0 8px 0;
            font-weight: 600;
        }

        .modal-subtitle {
            color: #666;
            font-size: 14px;
            margin: 0;
        }

        .modal-form {
            margin-bottom: 20px;
        }

        .form-row {
            margin-bottom: 16px;
        }

        .modal-form label {
            display: block;
            margin-bottom: 6px;
            color: #444;
            font-weight: 600;
            font-size: 14px;
        }

        .modal-form input,
        .modal-form select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.2s;
        }

        .modal-form input:focus,
        .modal-form select:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 0 0 2px rgba(42, 82, 152, 0.1);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 24px;
        }

        .modal-buttons button {
            flex: 1;
        }

        .modal-link {
            text-align: center;
            margin-top: 16px;
            font-size: 14px;
            color: #666;
        }

        .modal-link a {
            color: #2a5298;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-link a:hover {
            text-decoration: underline;
        }

        .error-message {
            color: #dc3545;
            font-size: 13px;
            margin-top: 6px;
            display: none;
        }

        .trial-info {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 12px;
            margin-top: 20px;
            text-align: center;
            font-size: 14px;
        }

        .trial-count {
            font-weight: bold;
            color: #e74c3c;
        }

        .admin-link {
            position: absolute;
            top: 16px;
            left: 20px;
        }

        .admin-btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        .admin-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ */
        * {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            font-size: 14px;
            -webkit-text-size-adjust: 100%;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            padding: 16px 20px;
            text-align: center;
            position: relative;
        }

        h1 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .subtitle {
            opacity: 0.85;
            font-size: 13px;
            margin-top: 4px;
        }

        .main-content {
            padding: 15px;
        }

        .input-section,
        .result-section,
        .history-section {
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .input-section {
            background-color: #f9f9f9;
            border: 1px solid #eaeaea;
        }

        .result-section {
            background-color: #f0f7ff;
            border: 1px solid #cce0ff;
        }

        .history-section {
            background-color: #fff9e6;
            border: 1px solid #ffeaa7;
        }

        .section-title {
            font-size: 17px;
            color: #1e3c72;
            margin-top: 0;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid rgba(30, 60, 114, 0.15);
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #444;
            font-size: 14px;
        }

        select,
        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.2s;
            background-color: white;
            -webkit-appearance: none;
            appearance: none;
        }

        select:focus,
        input:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 0 0 2px rgba(42, 82, 152, 0.1);
        }

        .btn {
            background-color: #2a5298;
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.2s;
            margin-right: 8px;
            margin-top: 8px;
            width: 100%;
            display: block;
        }

        .btn:hover,
        .btn:active {
            background-color: #1e3c72;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover,
        .btn-secondary:active {
            background-color: #5a6268;
        }

        .btn-success {
            background-color: #28a745;
        }

        .btn-success:hover,
        .btn-success:active {
            background-color: #218838;
        }

        .btn-danger {
            background-color: #dc3545;
        }

        .btn-danger:hover,
        .btn-danger:active {
            background-color: #c82333;
        }

        .button-group {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .button-group .btn {
            flex: 1;
            margin: 0;
            padding: 12px 10px;
        }

        .chart-container {
            width: 100%;
            height: 280px;
            margin-top: 15px;
        }

        .history-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .history-table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            min-width: 600px;
        }

        .history-table th {
            background-color: #1e3c72;
            color: white;
            padding: 12px 10px;
            text-align: left;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
        }

        .history-table td {
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        .history-table tr:last-child td {
            border-bottom: none;
        }

        .history-table tr:hover {
            background-color: #f8f9fa;
        }

        .hidden {
            display: none;
        }

        .status-up {
            color: #28a745;
            font-weight: 600;
        }

        .status-down {
            color: #dc3545;
            font-weight: 600;
        }

        .record-action {
            padding: 6px 10px;
            margin-right: 5px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }

        .record-edit {
            background-color: #ffc107;
            color: #212529;
        }

        .record-delete {
            background-color: #dc3545;
            color: white;
        }

        .auto-calculation-note {
            font-size: 13px;
            color: #666;
            font-style: italic;
            margin-top: 12px;
            text-align: center;
            line-height: 1.4;
        }

        footer {
            text-align: center;
            padding: 16px;
            color: #666;
            font-size: 12px;
            border-top: 1px solid #eee;
            background-color: #f9f9f9;
            line-height: 1.4;
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            body {
                padding: 8px;
            }

            .main-content {
                padding: 12px;
            }

            .input-section,
            .result-section,
            .history-section {
                padding: 14px;
                margin-bottom: 12px;
            }

            .section-title {
                font-size: 16px;
                margin-bottom: 14px;
            }

            select,
            input {
                padding: 14px;
                font-size: 16px;
                /* å¢åŠ å­—ä½“å¤§å°ä¾¿äºè§¦æ‘¸ */
            }

            .btn {
                padding: 16px;
                font-size: 16px;
            }

            .recommendation-result {
                font-size: 24px;
                padding: 16px;
            }

            .chart-container {
                height: 250px;
            }

            .history-table th,
            .history-table td {
                padding: 8px 6px;
                font-size: 12px;
            }

            .user-section {
                position: static;
                margin-top: 15px;
                justify-content: center;
            }

            .admin-link {
                position: static;
                margin-bottom: 10px;
                text-align: center;
            }

            .handicap-tab {
                padding: 10px 12px;
                font-size: 14px;
            }

            .dual-recommendation {
                flex-direction: column;
                gap: 10px;
            }

            .history-table {
                min-width: 700px;
            }
        }

        /* å°å±å¹•æ‰‹æœºä¼˜åŒ– */
        @media (max-width: 480px) {
            h1 {
                font-size: 18px;
            }

            .subtitle {
                font-size: 12px;
            }

            .recommendation-result {
                font-size: 22px;
                padding: 14px;
            }

            .chart-container {
                height: 220px;
            }

            .button-group {
                flex-direction: column;
                gap: 6px;
            }

            .history-table th {
                font-size: 12px;
                padding: 10px 6px;
            }

            .history-table td {
                font-size: 11px;
                padding: 8px 5px;
            }

            .modal-content {
                padding: 20px;
                width: 95%;
            }

            .modal-buttons {
                flex-direction: column;
            }
        }

        /* é˜²æ­¢iOS safariçš„ç¼©æ”¾ */
        input,
        select,
        textarea {
            font-size: 16px !important;
        }

        /* è§¦æ‘¸åé¦ˆä¼˜åŒ– */
        .btn:active,
        .record-action:active {
            transform: scale(0.98);
            transition: transform 0.1s;
        }

        /* ä¸‹æ‹‰é€‰æ‹©æ¡†ä¼˜åŒ– */
        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }
        
        /* æ–°å¢åŠ è½½åŠ¨ç”»æ ·å¼ */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
        }
        
        .loading-text {
            margin-top: 15px;
            font-size: 16px;
        }
        
        .recommendation-result {
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            padding: 12px;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        
        .recommendation-up {
            color: #28a745;
            background-color: rgba(40, 167, 69, 0.08);
            border: 2px solid #28a745;
        }
        
        .recommendation-down {
            color: #dc3545;
            background-color: rgba(220, 53, 69, 0.08);
            border: 2px solid #dc3545;
        }
        
        .recommendation-neutral {
            color: #6c757d;
            background-color: rgba(108, 117, 125, 0.08);
            border: 2px solid #6c757d;
        }
        
        /* ç½‘ç»œçŠ¶æ€æŒ‡ç¤ºå™¨ */
        .network-status {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1001;
            display: none;
        }
        
        .network-online {
            background-color: rgba(40, 167, 69, 0.9);
            color: white;
        }
        
        .network-offline {
            background-color: rgba(220, 53, 69, 0.9);
            color: white;
        }
        
        /* æœ¬åœ°å­˜å‚¨æ ‡è¯† */
        .local-storage-badge {
            color: #dc3545;
            font-size: 10px;
            margin-left: 5px;
            font-weight: bold;
        }
        
        .cloud-storage-badge {
            color: #28a745;
            font-size: 10px;
            margin-left: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    
    <!-- ç½‘ç»œçŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div id="networkStatus" class="network-status network-online">
        ç½‘ç»œè¿æ¥æ­£å¸¸
    </div>
    
    <!-- å…¨å±€åŠ è½½é®ç½© -->
    <div id="globalLoading" class="loading-overlay">
        <div class="spinner" style="width: 40px; height: 40px; border-width: 4px;"></div>
        <div class="loading-text" id="loadingText">æ­£åœ¨å¤„ç†ï¼Œè¯·ç¨å€™...</div>
    </div>

    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ç”¨æˆ·ç™»å½•</h2>
                <p class="modal-subtitle">è¯·ä½¿ç”¨æ‚¨çš„è´¦æˆ·ç™»å½•</p>
            </div>
            <div class="modal-form">
                <div class="form-row">
                    <label for="loginUsername">ç”¨æˆ·å</label>
                    <input type="text" id="loginUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                    <div id="loginUsernameError" class="error-message"></div>
                </div>
                <div class="form-row">
                    <label for="loginPassword">å¯†ç </label>
                    <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
                    <div id="loginPasswordError" class="error-message"></div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn" id="loginBtn">ç™»å½•</button>
                <button class="btn btn-secondary" id="cancelLoginBtn">å–æ¶ˆ</button>
            </div>
            <div class="modal-link">
                è¿˜æ²¡æœ‰è´¦æˆ·ï¼Ÿ <a id="showRegisterLink">ç«‹å³æ³¨å†Œ</a>
            </div>
        </div>
    </div>

    <!-- æ³¨å†Œæ¨¡æ€æ¡† -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ç”¨æˆ·æ³¨å†Œ</h2>
                <p class="modal-subtitle">æ³¨å†Œæˆä¸ºæ­£å¼ä¼šå‘˜ï¼Œäº«å—æ— é™åˆ¶è®°å½•åŠŸèƒ½</p>
            </div>
            <div class="modal-form">
                <div class="form-row">
                    <label for="registerUsername">ç”¨æˆ·å</label>
                    <input type="text" id="registerUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·åï¼ˆè‡³å°‘3ä¸ªå­—ç¬¦ï¼‰">
                    <div id="registerUsernameError" class="error-message"></div>
                </div>
                <div class="form-row">
                    <label for="registerPassword">å¯†ç </label>
                    <input type="password" id="registerPassword" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä¸ªå­—ç¬¦ï¼‰">
                    <div id="registerPasswordError" class="error-message"></div>
                </div>
                <div class="form-row">
                    <label for="registerConfirmPassword">ç¡®è®¤å¯†ç </label>
                    <input type="password" id="registerConfirmPassword" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
                    <div id="registerConfirmPasswordError" class="error-message"></div>
                </div>
                <div class="form-row">
                    <label for="invitationCode">é‚€è¯·ç </label>
                    <select id="invitationCode">
                        <option value="">è¯·é€‰æ‹©é‚€è¯·ç </option>
                        <!-- é‚€è¯·ç é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </select>
                    <div id="invitationCodeError" class="error-message"></div>
                    <div style="font-size: 12px; color: #666; margin-top: 4px;">
                        å¦‚æœæ²¡æœ‰å¯ç”¨é‚€è¯·ç ï¼Œæ‚¨å¯ä»¥å…ˆè¯•ç”¨ï¼ˆé™18æ¬¡è®°å½•ï¼‰ã€‚
                    </div>
                </div>

                <div style="margin-top: 12px; display: flex; flex-direction: column; gap: 8px;">
                    <button type="button" class="btn" id="fileImportBtn" style="font-size: 20px;">
                        ğŸ“ é€‰æ‹©æ–‡ä»¶å¯¼å…¥
                    </button>
                    <button type="button" class="btn btn-success" id="manualImportBtn" style="font-size: 20px;">
                        âœï¸ æ‰‹åŠ¨è¾“å…¥é‚€è¯·ç 
                    </button>
                    <button type="button" class="user-btn" id="refreshInviteListBtn" style="font-size: 20px;">
                        ğŸ”„ åˆ·æ–°åˆ—è¡¨
                    </button>
                </div>

                <!-- æ–‡ä»¶åˆ†äº«è¯´æ˜ -->
                <div
                    style="font-size: 11px; color: #666; margin-top: 12px; line-height: 1.4; padding: 8px; background-color: #f5f5f5; border-radius: 6px;">
                    <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong>
                    1. ä»ç®¡ç†å‘˜å¤„è·å–é‚€è¯·ç æ–‡ä»¶ (.dat)<br>
                    2. ç‚¹å‡»"å¯¼å…¥æ–‡ä»¶"é€‰æ‹©æ–‡ä»¶<br>
                    3. ç‚¹å‡»"åˆ·æ–°åˆ—è¡¨"æŸ¥çœ‹å¯ç”¨é‚€è¯·ç <br>
                    4. é€‰æ‹©é‚€è¯·ç å®Œæˆæ³¨å†Œ
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-success" id="registerBtn">æ³¨å†Œ</button>
                <button class="btn btn-secondary" id="cancelRegisterBtn">å–æ¶ˆ</button>
            </div>
            <div class="modal-link">
                å·²æœ‰è´¦æˆ·ï¼Ÿ <a id="showLoginLink">ç«‹å³ç™»å½•</a>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>è¶³çƒè®©çƒ/å¤§å°ç›˜å£è®°å½•è½¯ä»¶</h1>
            <div class="subtitle">è®°å½•ã€åˆ†æã€æ¨èè¶³çƒè®©çƒç›˜å’Œå¤§å°ç›˜æ•°æ®</div>
            <div class="user-section">
                <div class="user-info" id="userInfo">
                    <!-- ç”¨æˆ·ä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
                </div>
                <div class="user-actions" id="userActions">
                    <!-- ç”¨æˆ·æ“ä½œæŒ‰é’®å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
                </div>
            </div>
        </header>
        <div class="main-content">
            <!-- è¯•ç”¨æç¤ºä¿¡æ¯ -->
            <div id="trialInfo" class="trial-info" style="display: none;">
                æ‚¨æ˜¯è¯•ç”¨ç”¨æˆ·ï¼Œå‰©ä½™ä¿å­˜æ¬¡æ•°: <span id="trialCount" class="trial-count">18</span> æ¬¡
            </div>

            <!-- ç›˜å£ç±»å‹åˆ‡æ¢æ ‡ç­¾ -->
            <div class="handicap-tabs">
                <button class="handicap-tab active" data-tab="asian-handicap">è®©çƒç›˜</button>
                <button class="handicap-tab" data-tab="over-under">å¤§å°ç›˜</button>
            </div>

            <!-- è®©çƒç›˜å†…å®¹ -->
            <div id="asian-handicap-content" class="handicap-content active">
                <div class="input-section">
                    <h2 class="section-title">è®©çƒç›˜æ•°æ®å½•å…¥</h2>
                    <!-- æ–°å¢èµ›äº‹åç§°è¾“å…¥æ¡† -->
                    <div class="form-group">
                        <label for="asian-match-name">èµ›äº‹åç§°</label>
                        <input type="text" id="asian-match-name" placeholder="è¯·è¾“å…¥èµ›äº‹åç§°ï¼Œä¾‹å¦‚ï¼šæ›¼åŸ vs åˆ©ç‰©æµ¦">
                    </div>
                    <div class="form-group">
                        <label for="asian-initial-handicap">åˆå§‹ç›˜å£</label>
                        <select id="asian-initial-handicap">
                            <option value="">è¯·é€‰æ‹©</option>
                            <!-- ç›˜å£ä»0åˆ°3ï¼Œé€’å¢åº¦ä¸º0.25 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="asian-current-handicap">å³æ—¶ç›˜å£</label>
                        <select id="asian-current-handicap">
                            <option value="">è¯·é€‰æ‹©</option>
                            <!-- ç›˜å£ä»0åˆ°3ï¼Œé€’å¢åº¦ä¸º0.25 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="asian-initial-water">åˆå§‹æ°´ä½</label>
                        <select id="asian-initial-water">
                            <option value="">è¯·é€‰æ‹©</option>
                            <!-- æ°´ä½ä»0.7åˆ°1.2ï¼Œé€’å¢åº¦ä¸º0.01 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="asian-current-water">å³æ—¶æ°´ä½</label>
                        <select id="asian-current-water">
                            <option value="">è¯·é€‰æ‹©</option>
                            <!-- æ°´ä½ä»0.7åˆ°1.2ï¼Œé€’å¢åº¦ä¸º0.01 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="asian-historical-record">å†å²æˆ˜ç»©</label>
                        <select id="asian-historical-record">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="win">èµ¢</option>
                            <option value="loss">è¾“</option>
                        </select>
                    </div>
                    <div class="auto-calculation-note">æç¤ºï¼šé€‰æ‹©æ‰€æœ‰é€‰é¡¹ï¼Œä¿å­˜è®°å½•æ¨èç»“æœå°†è‡ªåŠ¨ç”Ÿæˆ</div>
                    <div class="button-group">
                        <button class="btn btn-success" id="save-asian-btn">ä¿å­˜è®©çƒç›˜è®°å½•</button>
                        <button class="btn btn-secondary" id="reset-asian-btn">é‡ç½®è¡¨å•</button>
                    </div>
                </div>
            </div>

            <!-- å¤§å°ç›˜å†…å®¹ -->
            <div id="over-under-content" class="handicap-content">
                <div class="input-section">
                    <h2 class="section-title">å¤§å°ç›˜æ•°æ®å½•å…¥</h2>
                    <!-- æ–°å¢èµ›äº‹åç§°è¾“å…¥æ¡† -->
                    <div class="form-group">
                        <label for="size-match-name">èµ›äº‹åç§°</label>
                        <input type="text" id="size-match-name" placeholder="è¯·è¾“å…¥èµ›äº‹åç§°ï¼Œä¾‹å¦‚ï¼šæ›¼åŸ vs åˆ©ç‰©æµ¦">
                    </div>
                    <div class="form-group">
                        <label for="size-initial-handicap">åˆå§‹å¤§å°ç›˜</label>
                        <select id="size-initial-handicap">
                            <option value="">è¯·é€‰æ‹©</option>
                            <!-- å¤§å°ç›˜ä»1.5åˆ°4ï¼Œé€’å¢åº¦ä¸º0.25 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="size-current-handicap">å³æ—¶å¤§å°ç›˜</label>
                        <select id="size-current-handicap">
                            <option value="">è¯·é€‰æ‹©</option>
                            <!-- å¤§å°ç›˜ä»1.5åˆ°4ï¼Œé€’å¢åº¦ä¸º0.25 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="size-initial-water">åˆå§‹æ°´ä½</label>
                        <select id="size-initial-water">
                            <option value="">è¯·é€‰æ‹©</option>
                            <!-- æ°´ä½ä»0.7åˆ°1.2ï¼Œé€’å¢åº¦ä¸º0.01 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="size-current-water">å³æ—¶æ°´ä½</label>
                        <select id="size-current-water">
                            <option value="">è¯·é€‰æ‹©</option>
                            <!-- æ°´ä½ä»0.7åˆ°1.2ï¼Œé€’å¢åº¦ä¸º0.01 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="size-historical-record">å†å²æˆ˜ç»©</label>
                        <select id="size-historical-record">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="win">èµ¢</option>
                            <option value="loss">è¾“</option>
                        </select>
                    </div>
                    <div class="auto-calculation-note">æç¤ºï¼šé€‰æ‹©æ‰€æœ‰é€‰é¡¹ï¼Œä¿å­˜è®°å½•æ¨èç»“æœå°†è‡ªåŠ¨ç”Ÿæˆ</div>
                    <div class="button-group">
                        <button class="btn btn-success" id="save-size-btn">ä¿å­˜å¤§å°ç›˜è®°å½•</button>
                        <button class="btn btn-secondary" id="reset-size-btn">é‡ç½®è¡¨å•</button>
                    </div>
                </div>
            </div>

            <div class="result-section">
                <h2 class="section-title">æ¨èç»“æœä¸ç»Ÿè®¡</h2>
                <div class="dual-recommendation">
                    <div class="recommendation-box">
                        <div class="recommendation-label">è®©çƒç›˜æ¨è</div>
                        <div id="asian-recommendation-result" class="recommendation-result recommendation-neutral">
                            ç­‰å¾…è¾“å…¥ä¸­....
                        </div>
                        <div id="asian-recommendation-details"
                            style="font-size: 13px; color: #666; margin-top: 8px; line-height: 1.4;"></div>
                        <div id="asian-loading" style="display: none; margin-top: 10px;">
                            <div style="font-size: 12px; color: #666; text-align: center;">
                                <div class="spinner" style="display: inline-block; width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                æ­£åœ¨è®¡ç®—æ¨èç»“æœ...
                            </div>
                        </div>
                    </div>
                    <div class="recommendation-box">
                        <div class="recommendation-label">å¤§å°ç›˜æ¨è</div>
                        <div id="size-recommendation-result"
                            class="recommendation-result size-recommendation-neutral">ç­‰å¾…è¾“å…¥ä¸­....</div>
                        <div id="size-recommendation-details"
                            style="font-size: 13px; color: #666; margin-top: 8px; line-height: 1.4;"></div>
                        <div id="size-loading" style="display: none; margin-top: 10px;">
                            <div style="font-size: 12px; color: #666; text-align: center;">
                                <div class="spinner" style="display: inline-block; width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                æ­£åœ¨è®¡ç®—æ¨èç»“æœ...
                            </div>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="stats-chart"></canvas>
                </div>
            </div>
            <div class="history-section">
                <div class="history-controls">
                    <h2 class="section-title">å†å²è®°å½•</h2>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" id="toggle-history"
                            style="padding: 8px 12px; font-size: 13px;">éšè—è®°å½•</button>
                        <button class="btn btn-danger" id="clear-history"
                            style="padding: 8px 12px; font-size: 13px;">æ¸…ç©ºè®°å½•</button>
                        <button class="btn btn-success" id="sync-history"
                            style="padding: 8px 12px; font-size: 13px;">åŒæ­¥æ•°æ®</button>
                    </div>
                </div>
                <div id="history-content">
                    <div class="history-table-container">
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <!-- æ–°å¢èµ›äº‹åç§°åˆ— -->
                                    <th>èµ›äº‹åç§°</th>
                                    <th>ç›˜å£ç±»å‹</th>
                                    <th>ç›˜å£å˜åŒ–</th>
                                    <th>æ°´ä½å˜åŒ–</th>
                                    <th>å†å²æˆ˜ç»©</th>
                                    <th>æ¨èç»“æœ</th>
                                    <th>å®é™…ç»“æœ</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body">
                                <!-- å†å²è®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <footer>
            <p>è¶³çƒè®©çƒ/å¤§å°ç›˜å£è®°å½•è½¯ä»¶ &copy; 2025 | æ•°æ®ä»…ä¾›å‚è€ƒï¼Œå¨±ä¹å°±è¡Œ</p>
            <p id="apiStatus" style="font-size: 11px; color: #888;">APIçŠ¶æ€: æ­£åœ¨æ£€æŸ¥...</p>
        </footer>
    </div>

    <script>
        // ============== æœåŠ¡å™¨APIé…ç½® ============== //
        const API_CONFIG = {
             // æ ¹æ®éƒ¨ç½²ç¯å¢ƒè‡ªåŠ¨é€‰æ‹©APIåœ°å€
  getBaseUrl: function() {
    // å¦‚æœæ˜¯æœ¬åœ°å¼€å‘ç¯å¢ƒ
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      return 'http://localhost:3000';
    }
    // ç”Ÿäº§ç¯å¢ƒ - ä½¿ç”¨å®Œæ•´çš„åç«¯APIåœ°å€
    // æ³¨æ„ï¼šæ›¿æ¢ä¸ºä½ å®é™…çš„Verceléƒ¨ç½²åœ°å€
    return 'https://footballdream.vercel.app';
  },
  
  // æ¨èAPIç«¯ç‚¹
  endpoints: {
    register: '/api/register',
    login: '/api/login',
    history: '/api/history',
    records: '/api/records',
    asianRecommendation: '/api/recommend/asian',
    sizeRecommendation: '/api/recommend/size',
    invitationCodes: '/api/invitation-codes',
    test: '/api/test',
    stats: '/api/stats',
    userInfo: '/api/user/info',
    sync: '/api/sync'
  }
};

        // ============== APIæœåŠ¡ ============== //
        const APIService = {
            // æ˜¾ç¤ºå…¨å±€åŠ è½½
            showGlobalLoading: function(message = 'æ­£åœ¨å¤„ç†ï¼Œè¯·ç¨å€™...') {
                const loading = document.getElementById('globalLoading');
                const loadingText = document.getElementById('loadingText');
                loadingText.textContent = message;
                loading.style.display = 'flex';
            },

            // éšè—å…¨å±€åŠ è½½
            hideGlobalLoading: function() {
                const loading = document.getElementById('globalLoading');
                loading.style.display = 'none';
            },

            // æ˜¾ç¤ºç½‘ç»œçŠ¶æ€
            showNetworkStatus: function(isOnline, message) {
                const networkStatus = document.getElementById('networkStatus');
                networkStatus.textContent = message;
                networkStatus.className = `network-status ${isOnline ? 'network-online' : 'network-offline'}`;
                networkStatus.style.display = 'block';
                
                // 3ç§’åè‡ªåŠ¨éšè—
                setTimeout(() => {
                    networkStatus.style.display = 'none';
                }, 3000);
            },

            // é€šç”¨è¯·æ±‚æ–¹æ³•
            async request(endpoint, method = 'GET', data = null, requiresAuth = false) {
                const url = `${API_CONFIG.getBaseUrl()}${endpoint}`;
                const headers = {
                    'Content-Type': 'application/json',
                };
                
                // æ·»åŠ è®¤è¯å¤´ï¼ˆå¦‚æœéœ€è¦ï¼‰
                if (requiresAuth) {
                    const token = localStorage.getItem('authToken');
                    if (token) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }
                }
                
                const options = {
                    method,
                    headers,
                    body: data ? JSON.stringify(data) : null
                };
                
                try {
                    const response = await fetch(url, options);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTPé”™è¯¯ ${response.status}: ${errorText}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error(`APIè¯·æ±‚å¤±è´¥ (${endpoint}):`, error);
                    
                    // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
                    if (!navigator.onLine) {
                        this.showNetworkStatus(false, 'ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œæ­£åœ¨ä½¿ç”¨æœ¬åœ°å­˜å‚¨');
                    } else if (error.message.includes('Failed to fetch')) {
                        this.showNetworkStatus(false, 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œæ­£åœ¨ä½¿ç”¨æœ¬åœ°å­˜å‚¨');
                    }
                    
                    throw error;
                }
            },

            // æµ‹è¯•æœåŠ¡å™¨è¿æ¥
            testConnection: async function() {
                try {
                    const response = await this.request(API_CONFIG.endpoints.test);
                    return response;
                } catch (error) {
                    console.error('æœåŠ¡å™¨è¿æ¥æµ‹è¯•å¤±è´¥:', error);
                    return { success: false, error: error.message };
                }
            },

            // ç”¨æˆ·æ³¨å†Œ
            register: async function(username, password, invitationCode) {
                return this.request(API_CONFIG.endpoints.register, 'POST', {
                    username,
                    password,
                    invitationCode
                });
            },

            // ç”¨æˆ·ç™»å½•
            login: async function(username, password) {
                const result = await this.request(API_CONFIG.endpoints.login, 'POST', {
                    username,
                    password
                });
                
                // å¦‚æœç™»å½•æˆåŠŸï¼Œä¿å­˜token
                if (result.success && result.token) {
                    localStorage.setItem('authToken', result.token);
                }
                
                return result;
            },

            // è·å–å†å²è®°å½•
            getHistory: async function(userId) {
                return this.request(`${API_CONFIG.endpoints.history}?userId=${userId}`, 'GET');
            },

            // ä¿å­˜è®°å½•
            saveRecord: async function(record) {
                return this.request(API_CONFIG.endpoints.records, 'POST', record, true);
            },

            // æ›´æ–°è®°å½•
            updateRecord: async function(id, data) {
                return this.request(`${API_CONFIG.endpoints.records}/${id}`, 'PUT', data, true);
            },

            // åˆ é™¤è®°å½•
            deleteRecord: async function(id) {
                return this.request(`${API_CONFIG.endpoints.records}/${id}`, 'DELETE', null, true);
            },

            // è·å–é‚€è¯·ç 
            getInvitationCodes: async function() {
                return this.request(API_CONFIG.endpoints.invitationCodes, 'GET');
            },

            // å¯¼å…¥é‚€è¯·ç 
            importInvitationCodes: async function(codes, createdBy = 'admin') {
                return this.request(API_CONFIG.endpoints.invitationCodes, 'POST', {
                    codes,
                    createdBy
                });
            },

            // è·å–è®©çƒç›˜æ¨è
            getAsianRecommendation: async function(data) {
                return this.request(API_CONFIG.endpoints.asianRecommendation, 'POST', data);
            },

            // è·å–å¤§å°ç›˜æ¨è
            getSizeRecommendation: async function(data) {
                return this.request(API_CONFIG.endpoints.sizeRecommendation, 'POST', data);
            }
        };

        // ============== å­˜å‚¨ç®¡ç†å™¨ï¼ˆæœ¬åœ°å¤‡ä»½ï¼‰ ============== //
        const StorageManager = {
            // ä¿å­˜è®°å½•åˆ°æœ¬åœ°å¤‡ä»½
            saveRecordLocal: function(record) {
                const records = this.getLocalRecords();
                record.id = `local_${Date.now()}`;
                record.created_at = new Date().toISOString();
                records.push(record);
                localStorage.setItem('football_records_local', JSON.stringify(records));
                return record.id;
            },

            // è·å–æœ¬åœ°è®°å½•
            getLocalRecords: function() {
                return JSON.parse(localStorage.getItem('football_records_local') || '[]');
            },

            // æ›´æ–°æœ¬åœ°è®°å½•
            updateRecordLocal: function(id, updates) {
                const records = this.getLocalRecords();
                const index = records.findIndex(r => r.id === id);
                if (index !== -1) {
                    records[index] = { ...records[index], ...updates };
                    localStorage.setItem('football_records_local', JSON.stringify(records));
                    return true;
                }
                return false;
            },

            // åˆ é™¤æœ¬åœ°è®°å½•
            deleteRecordLocal: function(id) {
                let records = this.getLocalRecords();
                records = records.filter(r => r.id !== id);
                localStorage.setItem('football_records_local', JSON.stringify(records));
                return true;
            },

            // æ¸…ç©ºæœ¬åœ°è®°å½•
            clearLocalRecords: function() {
                localStorage.removeItem('football_records_local');
            },

            // è·å–æœªåŒæ­¥çš„è®°å½•
            getUnsyncedRecords: function() {
                return this.getLocalRecords();
            }
        };

        // ============== ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ ============== //
        const UserSystem = {
            // åˆå§‹åŒ–ç”¨æˆ·æ•°æ®
            init: function() {
                console.log('å¼€å§‹åˆå§‹åŒ–ç”¨æˆ·ç³»ç»Ÿ...');

                // åˆå§‹åŒ–é»˜è®¤ç”¨æˆ·
                if (!localStorage.getItem('users')) {
                    const defaultUsers = [{
                        id: 1,
                        username: 'admin',
                        password: 'admin123',
                        userType: 'admin',
                        registrationDate: new Date().toISOString(),
                        lastLogin: new Date().toISOString()
                    }];
                    localStorage.setItem('users', JSON.stringify(defaultUsers));
                }

                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                this.checkLoginStatus();

                console.log('ç”¨æˆ·ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
            },

            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            checkLoginStatus: function() {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
                if (currentUser) {
                    this.updateUI(currentUser);
                    
                    // æ›´æ–°è¯•ç”¨ä¿¡æ¯æ˜¾ç¤º
                    if (currentUser.userType === 'trial') {
                        this.updateTrialInfo(currentUser.username);
                    }
                } else {
                    this.showGuestUI();
                }
            },

            // æ˜¾ç¤ºæ¸¸å®¢UI
            showGuestUI: function() {
                document.getElementById('userInfo').innerHTML = `
                    <div class="user-name">æ¸¸å®¢</div>
                    <div class="user-type">è¯•ç”¨ç”¨æˆ·</div>
                `;
                document.getElementById('userActions').innerHTML = `
                    <button class="user-btn" id="loginBtnHeader">ç™»å½•</button>
                    <button class="user-btn" id="registerBtnHeader">æ³¨å†Œ</button>
                `;

                // æ˜¾ç¤ºè¯•ç”¨ä¿¡æ¯
                const trialInfoElement = document.getElementById('trialInfo');
                if (trialInfoElement) {
                    trialInfoElement.style.display = 'block';
                    this.updateGuestTrialInfo();
                }

                // ç»‘å®šäº‹ä»¶
                document.getElementById('loginBtnHeader').addEventListener('click', () => this.showLoginModal());
                document.getElementById('registerBtnHeader').addEventListener('click', () => this.showRegisterModal());
            },

            // æ›´æ–°æ¸¸å®¢è¯•ç”¨ä¿¡æ¯
            updateGuestTrialInfo: function() {
                const localRecords = StorageManager.getLocalRecords();
                const usedCount = localRecords.length;
                const remaining = Math.max(0, 18 - usedCount);
                
                const trialCountElement = document.getElementById('trialCount');
                if (trialCountElement) {
                    trialCountElement.textContent = remaining;
                }
                
                const trialInfoElement = document.getElementById('trialInfo');
                if (trialInfoElement) {
                    trialInfoElement.innerHTML = `
                        æ‚¨æ˜¯è¯•ç”¨ç”¨æˆ·ï¼Œå‰©ä½™ä¿å­˜æ¬¡æ•°: <span class="trial-count">${remaining}</span> æ¬¡
                        <div style="font-size: 11px; margin-top: 4px; opacity: 0.8;">
                            å½“å‰ä½¿ç”¨æœ¬åœ°å­˜å‚¨ | å·²ä½¿ç”¨: ${usedCount}æ¬¡
                        </div>
                    `;
                }
            },

            // æ›´æ–°ç”¨æˆ·UI
            updateUI: function(user) {
                document.getElementById('userInfo').innerHTML = `
                    <div class="user-name">${user.username}</div>
                    <div class="user-type">${user.userType === 'admin' ? 'ç®¡ç†å‘˜' : (user.userType === 'registered' ? 'æ³¨å†Œä¼šå‘˜' : 'è¯•ç”¨ç”¨æˆ·')}</div>
                `;

                let actionsHTML = '';
                if (user.userType === 'admin') {
                    actionsHTML = `<button class="user-btn" id="logoutBtn">é€€å‡º</button>`;
                } else {
                    actionsHTML = `<button class="user-btn" id="logoutBtn">é€€å‡º</button>`;
                }
                document.getElementById('userActions').innerHTML = actionsHTML;

                // æ˜¾ç¤ºæˆ–éšè—è¯•ç”¨ä¿¡æ¯
                const trialInfoElement = document.getElementById('trialInfo');
                if (trialInfoElement) {
                    if (user.userType === 'trial') {
                        trialInfoElement.style.display = 'block';
                    } else {
                        trialInfoElement.style.display = 'none';
                    }
                }

                // ç»‘å®šé€€å‡ºäº‹ä»¶
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
            },

            // æ›´æ–°è¯•ç”¨ä¿¡æ¯
            updateTrialInfo: function(username) {
                const trialCountElement = document.getElementById('trialCount');
                if (trialCountElement) {
                    // ä»æœåŠ¡å™¨è·å–è¯•ç”¨ä¿¡æ¯
                    // è¿™é‡Œéœ€è¦è°ƒç”¨APIè·å–ç”¨æˆ·çš„è¯•ç”¨æ¬¡æ•°
                    // æš‚æ—¶æ˜¾ç¤ºé»˜è®¤å€¼
                    trialCountElement.textContent = '18';
                }
            },

            // æ˜¾ç¤ºç™»å½•æ¨¡æ€æ¡†
            showLoginModal: function() {
                document.getElementById('loginModal').style.display = 'flex';
                document.getElementById('loginUsername').focus();
            },

            // æ˜¾ç¤ºæ³¨å†Œæ¨¡æ€æ¡†
            showRegisterModal: function() {
    document.getElementById('registerModal').style.display = 'flex';
    document.getElementById('registerUsername').focus();

    // æ¸…é™¤æ‰€æœ‰é”™è¯¯æ¶ˆæ¯
    this.clearAllErrors();

    // åˆ·æ–°é‚€è¯·ç åˆ—è¡¨
    this.refreshInvitationCodeList();
    
    // ============ æ–°å¢ï¼šéšè—éœ€è¦è®¤è¯çš„æŒ‰é’® ============
    setTimeout(() => {
        // éšè—éœ€è¦ç®¡ç†å‘˜è®¤è¯çš„æŒ‰é’®
        const fileImportBtn = document.getElementById('fileImportBtn');
        const manualImportBtn = document.getElementById('manualImportBtn');
        
        if (fileImportBtn) {
            fileImportBtn.style.display = 'none';
        }
        if (manualImportBtn) {
            manualImportBtn.style.display = 'none';
        }
        
        // ä¿®æ”¹æŒ‰é’®å®¹å™¨å†…å®¹
        const buttonContainer = document.querySelector('.modal-form div[style*="flex-direction: column"]');
        if (buttonContainer) {
            buttonContainer.innerHTML = `
                <div style="text-align: center; padding: 10px; color: #666;">
                    <p style="margin: 0 0 8px 0; font-size: 14px; font-weight: bold;">é‚€è¯·ç è¯´æ˜</p>
                    <p style="margin: 0 0 4px 0; font-size: 12px;">é‚€è¯·ç éœ€è¦ä»ç®¡ç†å‘˜å¤„è·å–</p>
                    <p style="margin: 0 0 12px 0; font-size: 12px;">è¯·ç›´æ¥åœ¨ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹©å¯ç”¨é‚€è¯·ç </p>
                    <button type="button" class="user-btn" id="refreshInviteListBtn" style="font-size: 13px; padding: 8px 16px;">
                        ğŸ”„ åˆ·æ–°åˆ—è¡¨
                    </button>
                </div>
            `;
            
            // é‡æ–°ç»‘å®šåˆ·æ–°æŒ‰é’®äº‹ä»¶
            const refreshBtn = document.getElementById('refreshInviteListBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => this.refreshInvitationCodeList());
            }
        }
        
        // æ›´æ–°æ–‡ä»¶åˆ†äº«è¯´æ˜
        const fileShareNote = document.querySelector('.modal-form div[style*="ä½¿ç”¨è¯´æ˜"]');
        if (fileShareNote) {
            fileShareNote.innerHTML = `
                <strong>é‚€è¯·ç ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
                1. ä»ç®¡ç†å‘˜å¤„è·å–é‚€è¯·ç <br>
                2. åœ¨ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹©å¯ç”¨é‚€è¯·ç <br>
                3. å¦‚æœæ²¡æœ‰å¯ç”¨é‚€è¯·ç ï¼Œè¯·è”ç³»ç®¡ç†å‘˜<br>
                4. è¯•ç”¨ç”¨æˆ·æ— éœ€é‚€è¯·ç ï¼ˆé™18æ¬¡è®°å½•ï¼‰
            `;
        }
    }, 100);
},

            // éšè—æ‰€æœ‰æ¨¡æ€æ¡†
            hideAllModals: function() {
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('registerModal').style.display = 'none';
            },

            // ç™»å½•
            login: async function() {
                const username = document.getElementById('loginUsername').value.trim();
                const password = document.getElementById('loginPassword').value.trim();

                // éªŒè¯è¾“å…¥
                let isValid = true;
                if (!username) {
                    this.showError('loginUsernameError', 'è¯·è¾“å…¥ç”¨æˆ·å');
                    isValid = false;
                } else {
                    this.hideError('loginUsernameError');
                }

                if (!password) {
                    this.showError('loginPasswordError', 'è¯·è¾“å…¥å¯†ç ');
                    isValid = false;
                } else {
                    this.hideError('loginPasswordError');
                }

                if (!isValid) return;

                try {
                    APIService.showGlobalLoading('æ­£åœ¨ç™»å½•...');
                    const result = await APIService.login(username, password);
                    APIService.hideGlobalLoading();
                    
                    if (result.success) {
                        // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
                        const user = {
                            id: result.user.id,
                            username: result.user.username,
                            userType: result.user.user_type || result.user.userType,
                            trialCount: result.user.trial_count || 0,
                            trialEndDate: result.user.trial_end_date
                        };
                        
                        localStorage.setItem('currentUser', JSON.stringify(user));
                        
                        // æ›´æ–°UI
                        this.updateUI(user);
                        
                        // éšè—æ¨¡æ€æ¡†
                        this.hideAllModals();
                        
                        // é‡æ–°åŠ è½½å†å²è®°å½•
                        await loadHistory();
                        
                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        alert(`æ¬¢è¿å›æ¥ï¼Œ${user.username}ï¼`);
                    } else {
                        this.showError('loginPasswordError', result.error || 'ç™»å½•å¤±è´¥');
                    }
                } catch (error) {
                    APIService.hideGlobalLoading();
                    this.showError('loginPasswordError', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
                }
            },

            // æ³¨å†Œ
            register: async function() {
                const username = document.getElementById('registerUsername').value.trim();
                const password = document.getElementById('registerPassword').value.trim();
                const confirmPassword = document.getElementById('registerConfirmPassword').value.trim();
                const invitationCode = document.getElementById('invitationCode').value.trim();

                // éªŒè¯è¾“å…¥
                let isValid = true;
                if (!username || username.length < 3) {
                    this.showError('registerUsernameError', 'ç”¨æˆ·åè‡³å°‘éœ€è¦3ä¸ªå­—ç¬¦');
                    isValid = false;
                } else {
                    this.hideError('registerUsernameError');
                }

                if (!password || password.length < 6) {
                    this.showError('registerPasswordError', 'å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦');
                    isValid = false;
                } else {
                    this.hideError('registerPasswordError');
                }

                if (password !== confirmPassword) {
                    this.showError('registerConfirmPasswordError', 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                    isValid = false;
                } else {
                    this.hideError('registerConfirmPasswordError');
                }

                if (!invitationCode) {
                    this.showError('invitationCodeError', 'è¯·é€‰æ‹©é‚€è¯·ç ');
                    isValid = false;
                } else {
                    this.hideError('invitationCodeError');
                }

                if (!isValid) return;

                try {
                    APIService.showGlobalLoading('æ­£åœ¨æ³¨å†Œ...');
                    const result = await APIService.register(username, password, invitationCode);
                    APIService.hideGlobalLoading();
                    
                    if (result.success) {
                        // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
                        const user = {
                            id: result.user.id,
                            username: result.user.username,
                            userType: result.user.user_type || result.user.userType,
                            trialCount: result.user.trial_count || 0
                        };
                        
                        localStorage.setItem('currentUser', JSON.stringify(user));
                        
                        // æ›´æ–°UI
                        this.updateUI(user);
                        
                        // éšè—æ¨¡æ€æ¡†
                        this.hideAllModals();
                        
                        // é‡æ–°åŠ è½½å†å²è®°å½•
                        await loadHistory();
                        
                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        alert(`æ³¨å†ŒæˆåŠŸï¼æ¬¢è¿${user.userType === 'registered' ? 'æ³¨å†Œä¼šå‘˜' : 'è¯•ç”¨ç”¨æˆ·'}${user.username}`);
                    } else {
                        this.showError('invitationCodeError', result.error || 'æ³¨å†Œå¤±è´¥');
                    }
                } catch (error) {
                    APIService.hideGlobalLoading();
                    this.showError('invitationCodeError', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
                }
            },

            // é€€å‡ºç™»å½•
            logout: function() {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('authToken');
                this.showGuestUI();
                loadHistory();
                alert('å·²é€€å‡ºç™»å½•');
            },

            // æ£€æŸ¥æ˜¯å¦å¯ä»¥ä¿å­˜è®°å½•ï¼ˆæ¸¸å®¢ï¼‰
            canGuestSaveRecord: function() {
                const localRecords = StorageManager.getLocalRecords();
                return localRecords.length < 18;
            },

            // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
            showError: function(elementId, message) {
                const element = document.getElementById(elementId);
                element.textContent = message;
                element.style.display = 'block';
            },

            // éšè—é”™è¯¯æ¶ˆæ¯
            hideError: function(elementId) {
                const element = document.getElementById(elementId);
                element.style.display = 'none';
            },

            // æ¸…é™¤æ‰€æœ‰é”™è¯¯æ¶ˆæ¯
            clearAllErrors: function() {
                const errorElements = document.querySelectorAll('.error-message');
                errorElements.forEach(element => {
                    element.style.display = 'none';
                });
            },

            // åˆ·æ–°é‚€è¯·ç åˆ—è¡¨
            refreshInvitationCodeList: async function() {
                try {
                    const result = await APIService.getInvitationCodes();
                    const selectElement = document.getElementById('invitationCode');
                    
                    // æ¸…ç©ºç°æœ‰é€‰é¡¹
                    while (selectElement.options.length > 1) {
                        selectElement.remove(1);
                    }
                    
                    if (result.success && result.codes && result.codes.length > 0) {
                        result.codes.forEach(code => {
                            const option = document.createElement('option');
                            option.value = code.code;
                            option.textContent = `${code.code} (${code.created_by})`;
                            selectElement.appendChild(option);
                        });
                    } else {
                        const option = document.createElement('option');
                        option.value = "";
                        option.textContent = "æš‚æ— å¯ç”¨é‚€è¯·ç ";
                        selectElement.appendChild(option);
                    }
                } catch (error) {
                    console.error('è·å–é‚€è¯·ç å¤±è´¥:', error);
                }
            },

            // æ–‡ä»¶å¯¼å…¥é‚€è¯·ç 
            importViaFileInput: function() {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.dat,.txt,.json,.csv,text/plain,application/json,text/csv';
                
                fileInput.onchange = async function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = async function(event) {
                        try {
                            const content = event.target.result;
                            let codes = [];
                            
                            // å°è¯•è§£æä¸åŒæ ¼å¼
                            if (content.trim().startsWith('{')) {
                                const data = JSON.parse(content);
                                if (data.codes && Array.isArray(data.codes)) {
                                    codes = data.codes;
                                }
                            } else {
                                // æŒ‰è¡Œåˆ†å‰²
                                codes = content.split('\n')
                                    .filter(line => line.trim() !== '')
                                    .map(line => line.trim());
                            }
                            
                            if (codes.length > 0) {
                                APIService.showGlobalLoading('æ­£åœ¨å¯¼å…¥é‚€è¯·ç ...');
                                const result = await APIService.importInvitationCodes(codes, 'æ–‡ä»¶å¯¼å…¥');
                                APIService.hideGlobalLoading();
                                
                                if (result.success) {
                                    alert(`æˆåŠŸå¯¼å…¥ ${result.inserted.length} ä¸ªé‚€è¯·ç `);
                                    UserSystem.refreshInvitationCodeList();
                                } else {
                                    alert('å¯¼å…¥å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                                }
                            } else {
                                alert('æœªæ‰¾åˆ°æœ‰æ•ˆçš„é‚€è¯·ç ');
                            }
                        } catch (error) {
                            alert('æ–‡ä»¶è§£æå¤±è´¥: ' + error.message);
                        }
                    };
                    
                    reader.readAsText(file);
                };
                
                fileInput.click();
            },

            // æ‰‹åŠ¨è¾“å…¥é‚€è¯·ç 
            importManually: function() {
                const input = prompt('è¯·è¾“å…¥é‚€è¯·ç ï¼ˆå¤šä¸ªé‚€è¯·ç ç”¨é€—å·åˆ†éš”ï¼‰ï¼š');
                if (!input || input.trim() === '') return;
                
                const codes = input.split(',')
                    .map(code => code.trim())
                    .filter(code => code !== '');
                
                if (codes.length === 0) {
                    alert('æœªè¾“å…¥æœ‰æ•ˆçš„é‚€è¯·ç ');
                    return;
                }
                
                // è°ƒç”¨APIå¯¼å…¥
                APIService.importInvitationCodes(codes, 'æ‰‹åŠ¨è¾“å…¥')
                    .then(result => {
                        if (result.success) {
                            alert(`æˆåŠŸå¯¼å…¥ ${result.inserted.length} ä¸ªé‚€è¯·ç `);
                            UserSystem.refreshInvitationCodeList();
                        } else {
                            alert('å¯¼å…¥å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                        }
                    })
                    .catch(error => {
                        alert('å¯¼å…¥å¤±è´¥: ' + error.message);
                    });
            }
        };

        // ============== ç›˜å£ç±»å‹åˆ‡æ¢åŠŸèƒ½ ============== //
        function initHandicapTabs() {
            const tabs = document.querySelectorAll('.handicap-tab');
            const contents = document.querySelectorAll('.handicap-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabType = this.getAttribute('data-tab');

                    // ç§»é™¤æ‰€æœ‰activeç±»
                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));

                    // æ·»åŠ activeç±»åˆ°å½“å‰æ ‡ç­¾å’Œå†…å®¹
                    this.classList.add('active');
                    document.getElementById(`${tabType}-content`).classList.add('active');
                });
            });
        }

        function initHandicapOptions() {
            // åˆå§‹åŒ–è®©çƒç›˜ç›˜å£é€‰é¡¹ï¼ˆ0-3ï¼Œé€’å¢0.25ï¼‰
            const asianInitialHandicapSelect = document.getElementById('asian-initial-handicap');
            const asianCurrentHandicapSelect = document.getElementById('asian-current-handicap');

            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            asianInitialHandicapSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';
            asianCurrentHandicapSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';

            // è®©çƒç›˜ç›˜å£é€‰é¡¹ï¼ˆ0-3ï¼Œé€’å¢0.25ï¼‰
            const asianHandicapOptions = [0, 0.25, 0.5, 0.75, 1, 1.25, 1.5, 1.75, 2, 2.25, 2.5, 2.75, 3];
            asianHandicapOptions.forEach(value => {
                const option1 = document.createElement('option');
                option1.value = value.toFixed(2);
                option1.textContent = value.toFixed(2);
                asianInitialHandicapSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = value.toFixed(2);
                option2.textContent = value.toFixed(2);
                asianCurrentHandicapSelect.appendChild(option2);
            });

            // åˆå§‹åŒ–å¤§å°ç›˜ç›˜å£é€‰é¡¹ï¼ˆ1.5-4ï¼Œé€’å¢0.25ï¼‰
            const sizeInitialHandicapSelect = document.getElementById('size-initial-handicap');
            const sizeCurrentHandicapSelect = document.getElementById('size-current-handicap');

            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            sizeInitialHandicapSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';
            sizeCurrentHandicapSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';

            // å¤§å°ç›˜ç›˜å£é€‰é¡¹ï¼ˆ1.5-4ï¼Œé€’å¢0.25ï¼‰
            const sizeHandicapOptions = [];
            for (let i = 1.5; i <= 4; i += 0.25) {
                sizeHandicapOptions.push(i);
            }
            sizeHandicapOptions.forEach(value => {
                const option1 = document.createElement('option');
                option1.value = value.toFixed(2);
                option1.textContent = value.toFixed(2);
                sizeInitialHandicapSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = value.toFixed(2);
                option2.textContent = value.toFixed(2);
                sizeCurrentHandicapSelect.appendChild(option2);
            });
        }

        function initWaterOptions() {
            // åˆå§‹åŒ–æ°´ä½é€‰é¡¹ï¼ˆ0.7-1.2ï¼Œé€’å¢0.01ï¼‰
            const asianInitialWaterSelect = document.getElementById('asian-initial-water');
            const asianCurrentWaterSelect = document.getElementById('asian-current-water');
            const sizeInitialWaterSelect = document.getElementById('size-initial-water');
            const sizeCurrentWaterSelect = document.getElementById('size-current-water');

            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            asianInitialWaterSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';
            asianCurrentWaterSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';
            sizeInitialWaterSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';
            sizeCurrentWaterSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';

            // æ°´ä½é€‰é¡¹ï¼ˆ0.7-1.2ï¼Œé€’å¢0.01ï¼‰
            const waterOptions = [];
            for (let i = 0.70; i <= 1.20; i += 0.01) {
                waterOptions.push(i);
            }
            waterOptions.forEach(value => {
                const option1 = document.createElement('option');
                option1.value = value.toFixed(2);
                option1.textContent = value.toFixed(2);
                asianInitialWaterSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = value.toFixed(2);
                option2.textContent = value.toFixed(2);
                asianCurrentWaterSelect.appendChild(option2);

                const option3 = document.createElement('option');
                option3.value = value.toFixed(2);
                option3.textContent = value.toFixed(2);
                sizeInitialWaterSelect.appendChild(option3);

                const option4 = document.createElement('option');
                option4.value = value.toFixed(2);
                option4.textContent = value.toFixed(2);
                sizeCurrentWaterSelect.appendChild(option4);
            });
        }

        // ============== äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ– ============== //
        function initEventListeners() {
            console.log('åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨...');

            // ç»‘å®šè¡¨å•æŒ‰é’®äº‹ä»¶
            document.getElementById('save-asian-btn').addEventListener('click', saveAsianRecord);
            document.getElementById('reset-asian-btn').addEventListener('click', resetAsianForm);
            document.getElementById('save-size-btn').addEventListener('click', saveSizeRecord);
            document.getElementById('reset-size-btn').addEventListener('click', resetSizeForm);
            document.getElementById('toggle-history').addEventListener('click', toggleHistory);
            document.getElementById('clear-history').addEventListener('click', clearHistory);
            document.getElementById('sync-history').addEventListener('click', syncHistory);

            // ç»‘å®šæ¨¡æ€æ¡†äº‹ä»¶
            document.getElementById('loginBtn').addEventListener('click', () => UserSystem.login());
            document.getElementById('cancelLoginBtn').addEventListener('click', () => UserSystem.hideAllModals());
            document.getElementById('registerBtn').addEventListener('click', () => UserSystem.register());
            document.getElementById('cancelRegisterBtn').addEventListener('click', () => UserSystem.hideAllModals());
            document.getElementById('showRegisterLink').addEventListener('click', () => {
                UserSystem.hideAllModals();
                UserSystem.showRegisterModal();
            });
            document.getElementById('showLoginLink').addEventListener('click', () => {
                UserSystem.hideAllModals();
                UserSystem.showLoginModal();
            });

            // ç»‘å®šé‚€è¯·ç åŠŸèƒ½æŒ‰é’®
            document.getElementById('fileImportBtn').addEventListener('click', () => UserSystem.importViaFileInput());
            document.getElementById('manualImportBtn').addEventListener('click', () => UserSystem.importManually());
            document.getElementById('refreshInviteListBtn').addEventListener('click', () => UserSystem.refreshInvitationCodeList());

            // ä¸ºè®©çƒç›˜æ‰€æœ‰è¾“å…¥æ¡†æ·»åŠ changeäº‹ä»¶ï¼Œç”¨äºè‡ªåŠ¨è®¡ç®—æ¨èç»“æœ
            document.getElementById('asian-initial-handicap').addEventListener('change', autoCalculateAsianRecommendation);
            document.getElementById('asian-current-handicap').addEventListener('change', autoCalculateAsianRecommendation);
            document.getElementById('asian-initial-water').addEventListener('change', autoCalculateAsianRecommendation);
            document.getElementById('asian-current-water').addEventListener('change', autoCalculateAsianRecommendation);
            document.getElementById('asian-historical-record').addEventListener('change', autoCalculateAsianRecommendation);

            // ä¸ºå¤§å°ç›˜æ‰€æœ‰è¾“å…¥æ¡†æ·»åŠ changeäº‹ä»¶ï¼Œç”¨äºè‡ªåŠ¨è®¡ç®—æ¨èç»“æœ
            document.getElementById('size-initial-handicap').addEventListener('change', autoCalculateSizeRecommendation);
            document.getElementById('size-current-handicap').addEventListener('change', autoCalculateSizeRecommendation);
            document.getElementById('size-initial-water').addEventListener('change', autoCalculateSizeRecommendation);
            document.getElementById('size-current-water').addEventListener('change', autoCalculateSizeRecommendation);
            document.getElementById('size-historical-record').addEventListener('change', autoCalculateSizeRecommendation);

            // ç½‘ç»œçŠ¶æ€ç›‘å¬
            window.addEventListener('online', () => {
                APIService.showNetworkStatus(true, 'ç½‘ç»œå·²æ¢å¤');
            });
            
            window.addEventListener('offline', () => {
                APIService.showNetworkStatus(false, 'ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œæ­£åœ¨ä½¿ç”¨æœ¬åœ°å­˜å‚¨');
            });

            console.log('äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–å®Œæˆ');
        }

        // ============== ä¸»åˆå§‹åŒ–å‡½æ•° ============== //
        async function initializeApplication() {
            console.log('=== å¼€å§‹åº”ç”¨ç¨‹åºåˆå§‹åŒ– ===');

            // ç¬¬ä¸€æ­¥ï¼šæµ‹è¯•æœåŠ¡å™¨è¿æ¥
            try {
                console.log('æµ‹è¯•æœåŠ¡å™¨è¿æ¥...');
                const testResult = await APIService.testConnection();
                
                if (testResult.success) {
                    console.log('æœåŠ¡å™¨è¿æ¥æˆåŠŸ:', testResult.message);
                    document.getElementById('apiStatus').textContent = 'APIçŠ¶æ€: æ­£å¸¸è¿æ¥';
                    document.getElementById('apiStatus').style.color = '#28a745';
                } else {
                    console.warn('æœåŠ¡å™¨è¿æ¥è­¦å‘Š:', testResult.error);
                    document.getElementById('apiStatus').textContent = 'APIçŠ¶æ€: è¿æ¥å¼‚å¸¸';
                    document.getElementById('apiStatus').style.color = '#dc3545';
                }
            } catch (error) {
                console.error('æœåŠ¡å™¨è¿æ¥å¤±è´¥:', error);
                document.getElementById('apiStatus').textContent = 'APIçŠ¶æ€: æ— æ³•è¿æ¥';
                document.getElementById('apiStatus').style.color = '#dc3545';
            }

            // ç¬¬äºŒæ­¥ï¼šåˆå§‹åŒ–ç”¨æˆ·ç³»ç»Ÿ
            UserSystem.init();

            // ç¬¬ä¸‰æ­¥ï¼šåˆå§‹åŒ–ç›˜å£ç±»å‹åˆ‡æ¢
            initHandicapTabs();

            // ç¬¬å››æ­¥ï¼šåˆå§‹åŒ–ç›˜å£å’Œæ°´ä½é€‰é¡¹
            initHandicapOptions();
            initWaterOptions();

            // ç¬¬äº”æ­¥ï¼šåŠ è½½å†å²è®°å½•
            await loadHistory();

            // ç¬¬å…­æ­¥ï¼šåˆå§‹åŒ–å›¾è¡¨
            initChart();

            // ç¬¬ä¸ƒæ­¥ï¼šåˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
            initEventListeners();

            console.log('=== åº”ç”¨ç¨‹åºåˆå§‹åŒ–å®Œæˆ ===');
        }

        // ============== æ¨èè®¡ç®—å‡½æ•° ============== //
        async function autoCalculateAsianRecommendation() {
            const initialHandicap = parseFloat(document.getElementById('asian-initial-handicap').value);
            const currentHandicap = parseFloat(document.getElementById('asian-current-handicap').value);
            const initialWater = parseFloat(document.getElementById('asian-initial-water').value);
            const currentWater = parseFloat(document.getElementById('asian-current-water').value);
            const historicalRecord = document.getElementById('asian-historical-record').value;
            const matchName = document.getElementById('asian-match-name').value.trim();

            // å¦‚æœæ‰€æœ‰å­—æ®µéƒ½æœ‰å€¼ï¼Œåˆ™è®¡ç®—æ¨èç»“æœ
            if (!isNaN(initialHandicap) && !isNaN(currentHandicap) &&
                !isNaN(initialWater) && !isNaN(currentWater) &&
                historicalRecord && matchName) {
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                document.getElementById('asian-loading').style.display = 'block';
                document.getElementById('asian-recommendation-result').textContent = "è®¡ç®—ä¸­...";
                document.getElementById('asian-recommendation-result').className = "recommendation-result recommendation-neutral";
                
                try {
                    // å‡†å¤‡è¯·æ±‚æ•°æ®
                    const requestData = {
                        matchName,
                        initialHandicap,
                        currentHandicap,
                        initialWater,
                        currentWater,
                        historicalRecord,
                        timestamp: new Date().toISOString()
                    };

                    // è°ƒç”¨æœåŠ¡å™¨APIè·å–æ¨è
                    const result = await APIService.getAsianRecommendation(requestData);
                    
                    // éšè—åŠ è½½çŠ¶æ€
                    document.getElementById('asian-loading').style.display = 'none';
                    
                    // æ›´æ–°ç•Œé¢
                    if (result.success) {
                        const recommendation = result.recommendation;
                        const resultElement = document.getElementById('asian-recommendation-result');
                        resultElement.textContent = recommendation;
                        
                        if (recommendation === "ä¸Šç›˜") {
                            resultElement.className = "recommendation-result recommendation-up";
                        } else if (recommendation === "ä¸‹ç›˜") {
                            resultElement.className = "recommendation-result recommendation-down";
                        } else {
                            resultElement.className = "recommendation-result recommendation-neutral";
                        }

                        // æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                        document.getElementById('asian-recommendation-details').textContent = result.details || '';
                    } else {
                        throw new Error(result.error || 'æœåŠ¡å™¨è¿”å›é”™è¯¯');
                    }
                    
                } catch (error) {
                    // éšè—åŠ è½½çŠ¶æ€
                    document.getElementById('asian-loading').style.display = 'none';
                    
                    // æ˜¾ç¤ºé”™è¯¯
                    const resultElement = document.getElementById('asian-recommendation-result');
                    resultElement.textContent = "è®¡ç®—å¤±è´¥";
                    resultElement.className = "recommendation-result recommendation-neutral";
                    document.getElementById('asian-recommendation-details').textContent = "è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•";
                    
                    console.error('æ¨èè®¡ç®—å¤±è´¥:', error);
                }
            } else {
                // å¦åˆ™æ˜¾ç¤ºç­‰å¾…è¾“å…¥
                const resultElement = document.getElementById('asian-recommendation-result');
                resultElement.textContent = "ç­‰å¾…è¾“å…¥";
                resultElement.className = "recommendation-result recommendation-neutral";
                document.getElementById('asian-recommendation-details').textContent = "è¯·å¡«å†™æ‰€æœ‰å­—æ®µä»¥è·å–æ¨èç»“æœ";
                document.getElementById('asian-loading').style.display = 'none';
            }
        }

        async function autoCalculateSizeRecommendation() {
            const initialHandicap = parseFloat(document.getElementById('size-initial-handicap').value);
            const currentHandicap = parseFloat(document.getElementById('size-current-handicap').value);
            const initialWater = parseFloat(document.getElementById('size-initial-water').value);
            const currentWater = parseFloat(document.getElementById('size-current-water').value);
            const historicalRecord = document.getElementById('size-historical-record').value;
            const matchName = document.getElementById('size-match-name').value.trim();

            // å¦‚æœæ‰€æœ‰å­—æ®µéƒ½æœ‰å€¼ï¼Œåˆ™è®¡ç®—æ¨èç»“æœ
            if (!isNaN(initialHandicap) && !isNaN(currentHandicap) &&
                !isNaN(initialWater) && !isNaN(currentWater) &&
                historicalRecord && matchName) {
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                document.getElementById('size-loading').style.display = 'block';
                document.getElementById('size-recommendation-result').textContent = "è®¡ç®—ä¸­...";
                document.getElementById('size-recommendation-result').className = "recommendation-result size-recommendation-neutral";
                
                try {
                    // å‡†å¤‡è¯·æ±‚æ•°æ®
                    const requestData = {
                        matchName,
                        initialHandicap,
                        currentHandicap,
                        initialWater,
                        currentWater,
                        historicalRecord,
                        timestamp: new Date().toISOString()
                    };

                    // è°ƒç”¨æœåŠ¡å™¨APIè·å–æ¨è
                    const result = await APIService.getSizeRecommendation(requestData);
                    
                    // éšè—åŠ è½½çŠ¶æ€
                    document.getElementById('size-loading').style.display = 'none';
                    
                    // æ›´æ–°ç•Œé¢
                    if (result.success) {
                        const recommendation = result.recommendation;
                        const resultElement = document.getElementById('size-recommendation-result');
                        resultElement.textContent = recommendation;
                        
                        if (recommendation === "å¤§çƒ") {
                            resultElement.className = "recommendation-result size-recommendation-up";
                        } else if (recommendation === "å°çƒ") {
                            resultElement.className = "recommendation-result size-recommendation-down";
                        } else {
                            resultElement.className = "recommendation-result size-recommendation-neutral";
                        }

                        // æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                        document.getElementById('size-recommendation-details').textContent = result.details || '';
                    } else {
                        throw new Error(result.error || 'æœåŠ¡å™¨è¿”å›é”™è¯¯');
                    }
                    
                } catch (error) {
                    // éšè—åŠ è½½çŠ¶æ€
                    document.getElementById('size-loading').style.display = 'none';
                    
                    // æ˜¾ç¤ºé”™è¯¯
                    const resultElement = document.getElementById('size-recommendation-result');
                    resultElement.textContent = "è®¡ç®—å¤±è´¥";
                    resultElement.className = "recommendation-result size-recommendation-neutral";
                    document.getElementById('size-recommendation-details').textContent = "è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•";
                    
                    console.error('æ¨èè®¡ç®—å¤±è´¥:', error);
                }
            } else {
                // å¦åˆ™æ˜¾ç¤ºç­‰å¾…è¾“å…¥
                const resultElement = document.getElementById('size-recommendation-result');
                resultElement.textContent = "ç­‰å¾…è¾“å…¥";
                resultElement.className = "recommendation-result size-recommendation-neutral";
                document.getElementById('size-recommendation-details').textContent = "è¯·å¡«å†™æ‰€æœ‰å­—æ®µä»¥è·å–æ¨èç»“æœ";
                document.getElementById('size-loading').style.display = 'none';
            }
        }

        // ============== ä¿å­˜è®°å½•åŠŸèƒ½ ============== //
        async function saveAsianRecord() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            // éªŒè¯æ•°æ®
            const matchName = document.getElementById('asian-match-name').value.trim();
            const initialHandicap = parseFloat(document.getElementById('asian-initial-handicap').value);
            const currentHandicap = parseFloat(document.getElementById('asian-current-handicap').value);
            const initialWater = parseFloat(document.getElementById('asian-initial-water').value);
            const currentWater = parseFloat(document.getElementById('asian-current-water').value);
            const historicalRecord = document.getElementById('asian-historical-record').value;
            const recommendationResult = document.getElementById('asian-recommendation-result').textContent;

            // éªŒè¯æ•°æ®
            if (!matchName) {
                alert('è¯·å…ˆè¾“å…¥èµ›äº‹åç§°ï¼');
                return;
            }

            if (isNaN(initialHandicap) || isNaN(currentHandicap) || 
                isNaN(initialWater) || isNaN(currentWater) || 
                !historicalRecord || 
                recommendationResult === "ç­‰å¾…è¾“å…¥" || 
                recommendationResult === "è®¡ç®—ä¸­..." || 
                recommendationResult === "è®¡ç®—å¤±è´¥") {
                alert('è¯·å…ˆå¡«å†™æ‰€æœ‰å­—æ®µå¹¶è·å–æ¨èç»“æœï¼');
                return;
            }

            // è®¡ç®—å˜åŒ–
            const handicapChange = (currentHandicap - initialHandicap).toFixed(2);
            const waterChange = (currentWater - initialWater).toFixed(2);

            // åˆ›å»ºè®°å½•å¯¹è±¡
            const record = {
                match_name: matchName,
                handicap_type: 'asian',
                initial_handicap: initialHandicap,
                current_handicap: currentHandicap,
                initial_water: initialWater,
                current_water: currentWater,
                handicap_change: parseFloat(handicapChange),
                water_change: parseFloat(waterChange),
                historical_record: historicalRecord,
                recommendation: recommendationResult,
                actual_result: ""
            };

            // å¦‚æœå·²ç™»å½•ï¼Œæ·»åŠ ç”¨æˆ·ID
            if (currentUser) {
                record.user_id = currentUser.id;
            }

            try {
                APIService.showGlobalLoading('æ­£åœ¨ä¿å­˜è®°å½•...');
                
                // å°è¯•ä¿å­˜åˆ°æœåŠ¡å™¨
                const result = await APIService.saveRecord(record);
                
                APIService.hideGlobalLoading();
                
                if (result.success) {
                    // é‡æ–°åŠ è½½å†å²è®°å½•
                    await loadHistory();
                    
                    // é‡ç½®è¡¨å•
                    resetAsianForm();
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    let successMsg = 'è®©çƒç›˜è®°å½•å·²ä¿å­˜åˆ°æœåŠ¡å™¨ï¼';
                    
                    // å¦‚æœæ˜¯è¯•ç”¨ç”¨æˆ·ï¼Œæ˜¾ç¤ºå‰©ä½™æ¬¡æ•°
                    if (currentUser && currentUser.userType === 'trial') {
                        successMsg += `\n\nå‰©ä½™è¯•ç”¨æ¬¡æ•°: ${17 - (currentUser.trialCount || 0)}/18`;
                    }
                    
                    alert(successMsg);
                    
                } else {
                    // å¤„ç†æœåŠ¡å™¨é”™è¯¯
                    if (result.error && result.error.includes('è¯•ç”¨')) {
                        alert('è¯•ç”¨é™åˆ¶: ' + result.error + '\nè¯·æ³¨å†Œæˆä¸ºä¼šå‘˜ç»§ç»­ä½¿ç”¨ï¼');
                        UserSystem.showRegisterModal();
                    } else {
                        throw new Error(result.error || 'æœåŠ¡å™¨ä¿å­˜å¤±è´¥');
                    }
                }
                
            } catch (error) {
                APIService.hideGlobalLoading();
                
                // å¦‚æœç”¨æˆ·æ˜¯æ¸¸å®¢æˆ–è€…æœåŠ¡å™¨ä¿å­˜å¤±è´¥ï¼Œå°è¯•æœ¬åœ°å­˜å‚¨
                if (!currentUser || error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                    // æ£€æŸ¥æ¸¸å®¢è¯•ç”¨æ¬¡æ•°
                    if (!currentUser && !UserSystem.canGuestSaveRecord()) {
                        alert('è¯•ç”¨æ¬¡æ•°å·²ç”¨å®Œï¼ˆæœ€å¤š18æ¬¡ï¼‰ã€‚è¯·æ³¨å†Œæˆä¸ºä¼šå‘˜ç»§ç»­ä½¿ç”¨ï¼');
                        UserSystem.showRegisterModal();
                        return;
                    }
                    
                    // ä¿å­˜åˆ°æœ¬åœ°
                    const localId = StorageManager.saveRecordLocal(record);
                    
                    // æ›´æ–°æ¸¸å®¢è¯•ç”¨ä¿¡æ¯
                    UserSystem.updateGuestTrialInfo();
                    
                    // é‡æ–°åŠ è½½å†å²è®°å½•ï¼ˆæ˜¾ç¤ºæœ¬åœ°è®°å½•ï¼‰
                    await loadHistory();
                    
                    // é‡ç½®è¡¨å•
                    resetAsianForm();
                    
                    alert('è®°å½•å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆç½‘ç»œæ¢å¤åå°†è‡ªåŠ¨åŒæ­¥ï¼‰ï¼');
                    
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + error.message);
                }
            }
        }

        async function saveSizeRecord() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            // éªŒè¯æ•°æ®
            const matchName = document.getElementById('size-match-name').value.trim();
            const initialHandicap = parseFloat(document.getElementById('size-initial-handicap').value);
            const currentHandicap = parseFloat(document.getElementById('size-current-handicap').value);
            const initialWater = parseFloat(document.getElementById('size-initial-water').value);
            const currentWater = parseFloat(document.getElementById('size-current-water').value);
            const historicalRecord = document.getElementById('size-historical-record').value;
            const recommendationResult = document.getElementById('size-recommendation-result').textContent;

            // éªŒè¯æ•°æ®
            if (!matchName) {
                alert('è¯·å…ˆè¾“å…¥èµ›äº‹åç§°ï¼');
                return;
            }

            if (isNaN(initialHandicap) || isNaN(currentHandicap) || 
                isNaN(initialWater) || isNaN(currentWater) || 
                !historicalRecord || 
                recommendationResult === "ç­‰å¾…è¾“å…¥" || 
                recommendationResult === "è®¡ç®—ä¸­..." || 
                recommendationResult === "è®¡ç®—å¤±è´¥") {
                alert('è¯·å…ˆå¡«å†™æ‰€æœ‰å­—æ®µå¹¶è·å–æ¨èç»“æœï¼');
                return;
            }

            // è®¡ç®—å˜åŒ–
            const handicapChange = (currentHandicap - initialHandicap).toFixed(2);
            const waterChange = (currentWater - initialWater).toFixed(2);

            // åˆ›å»ºè®°å½•å¯¹è±¡
            const record = {
                match_name: matchName,
                handicap_type: 'size',
                initial_handicap: initialHandicap,
                current_handicap: currentHandicap,
                initial_water: initialWater,
                current_water: currentWater,
                handicap_change: parseFloat(handicapChange),
                water_change: parseFloat(waterChange),
                historical_record: historicalRecord,
                recommendation: recommendationResult,
                actual_result: ""
            };

            // å¦‚æœå·²ç™»å½•ï¼Œæ·»åŠ ç”¨æˆ·ID
            if (currentUser) {
                record.user_id = currentUser.id;
            }

            try {
                APIService.showGlobalLoading('æ­£åœ¨ä¿å­˜è®°å½•...');
                
                // å°è¯•ä¿å­˜åˆ°æœåŠ¡å™¨
                const result = await APIService.saveRecord(record);
                
                APIService.hideGlobalLoading();
                
                if (result.success) {
                    // é‡æ–°åŠ è½½å†å²è®°å½•
                    await loadHistory();
                    
                    // é‡ç½®è¡¨å•
                    resetSizeForm();
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    let successMsg = 'å¤§å°ç›˜è®°å½•å·²ä¿å­˜åˆ°æœåŠ¡å™¨ï¼';
                    
                    // å¦‚æœæ˜¯è¯•ç”¨ç”¨æˆ·ï¼Œæ˜¾ç¤ºå‰©ä½™æ¬¡æ•°
                    if (currentUser && currentUser.userType === 'trial') {
                        successMsg += `\n\nå‰©ä½™è¯•ç”¨æ¬¡æ•°: ${17 - (currentUser.trialCount || 0)}/18`;
                    }
                    
                    alert(successMsg);
                    
                } else {
                    // å¤„ç†æœåŠ¡å™¨é”™è¯¯
                    if (result.error && result.error.includes('è¯•ç”¨')) {
                        alert('è¯•ç”¨é™åˆ¶: ' + result.error + '\nè¯·æ³¨å†Œæˆä¸ºä¼šå‘˜ç»§ç»­ä½¿ç”¨ï¼');
                        UserSystem.showRegisterModal();
                    } else {
                        throw new Error(result.error || 'æœåŠ¡å™¨ä¿å­˜å¤±è´¥');
                    }
                }
                
            } catch (error) {
                APIService.hideGlobalLoading();
                
                // å¦‚æœç”¨æˆ·æ˜¯æ¸¸å®¢æˆ–è€…æœåŠ¡å™¨ä¿å­˜å¤±è´¥ï¼Œå°è¯•æœ¬åœ°å­˜å‚¨
                if (!currentUser || error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                    // æ£€æŸ¥æ¸¸å®¢è¯•ç”¨æ¬¡æ•°
                    if (!currentUser && !UserSystem.canGuestSaveRecord()) {
                        alert('è¯•ç”¨æ¬¡æ•°å·²ç”¨å®Œï¼ˆæœ€å¤š18æ¬¡ï¼‰ã€‚è¯·æ³¨å†Œæˆä¸ºä¼šå‘˜ç»§ç»­ä½¿ç”¨ï¼');
                        UserSystem.showRegisterModal();
                        return;
                    }
                    
                    // ä¿å­˜åˆ°æœ¬åœ°
                    const localId = StorageManager.saveRecordLocal(record);
                    
                    // æ›´æ–°æ¸¸å®¢è¯•ç”¨ä¿¡æ¯
                    UserSystem.updateGuestTrialInfo();
                    
                    // é‡æ–°åŠ è½½å†å²è®°å½•ï¼ˆæ˜¾ç¤ºæœ¬åœ°è®°å½•ï¼‰
                    await loadHistory();
                    
                    // é‡ç½®è¡¨å•
                    resetSizeForm();
                    
                    alert('è®°å½•å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆç½‘ç»œæ¢å¤åå°†è‡ªåŠ¨åŒæ­¥ï¼‰ï¼');
                    
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + error.message);
                }
            }
        }

        // ============== å†å²è®°å½•ç®¡ç† ============== //
        async function loadHistory() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const tableBody = document.getElementById('history-table-body');
            
            // æ¸…ç©ºç°æœ‰å†…å®¹
            tableBody.innerHTML = '';
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const loadingRow = document.createElement('tr');
            loadingRow.innerHTML = `
                <td colspan="8" style="text-align: center; padding: 30px;">
                    <div class="spinner" style="width: 20px; height: 20px; margin: 0 auto;"></div>
                    <div style="margin-top: 10px; color: #666;">æ­£åœ¨åŠ è½½å†å²è®°å½•...</div>
                </td>
            `;
            tableBody.appendChild(loadingRow);
            
            try {
                let serverRecords = [];
                let localRecords = [];
                
                // å¦‚æœå·²ç™»å½•ï¼Œå°è¯•ä»æœåŠ¡å™¨åŠ è½½è®°å½•
                if (currentUser) {
                    try {
                        const result = await APIService.getHistory(currentUser.id);
                        if (result.success && result.records) {
                            serverRecords = result.records;
                        }
                    } catch (error) {
                        console.log('ä»æœåŠ¡å™¨åŠ è½½è®°å½•å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°è®°å½•:', error);
                    }
                }
                
                // åŠ è½½æœ¬åœ°è®°å½•
                localRecords = StorageManager.getLocalRecords();
                
                // ç§»é™¤åŠ è½½çŠ¶æ€
                tableBody.innerHTML = '';
                
                // åˆå¹¶è®°å½•ï¼ˆæœåŠ¡å™¨è®°å½•ä¼˜å…ˆï¼‰
                const allRecords = [...serverRecords, ...localRecords];
                
                if (allRecords.length === 0) {
                    const emptyRow = document.createElement('tr');
                    emptyRow.innerHTML = `<td colspan="8" style="text-align: center; padding: 30px; font-size: 14px; color: #666;">æš‚æ— å†å²è®°å½•</td>`;
                    tableBody.appendChild(emptyRow);
                    updateChartData(allRecords);
                    return;
                }
                
                // æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—
                allRecords.sort((a, b) => {
                    const dateA = new Date(a.created_at || 0);
                    const dateB = new Date(b.created_at || 0);
                    return dateB - dateA;
                });
                
                // æ¸²æŸ“è®°å½•
                allRecords.forEach(record => {
                    const row = document.createElement('tr');
                    
                    // ç¡®å®šå˜åŒ–çŠ¶æ€æ ·å¼
                    const handicapChangeClass = parseFloat(record.handicap_change) > 0 ? 'status-up' :
                        parseFloat(record.handicap_change) < 0 ? 'status-down' : '';
                    const waterChangeClass = parseFloat(record.water_change) > 0 ? 'status-up' :
                        parseFloat(record.water_change) < 0 ? 'status-down' : '';
                    
                    // ç›˜å£ç±»å‹æ˜¾ç¤º
                    const handicapTypeText = record.handicap_type === 'asian' ? 'è®©çƒç›˜' : 'å¤§å°ç›˜';
                    const handicapTypeClass = record.handicap_type === 'asian' ? 'status-up' : 'status-down';
                    
                    // åˆ¤æ–­æ˜¯å¦æ˜¯æœ¬åœ°è®°å½•
                    const isLocal = record.id && record.id.startsWith('local_');
                    const storageBadge = isLocal ? 
                        '<span class="local-storage-badge">[æœ¬åœ°]</span>' : 
                        '<span class="cloud-storage-badge">[äº‘ç«¯]</span>';
                    
                    row.innerHTML = `
                        <td>${record.match_name || 'æœªå‘½åèµ›äº‹'} ${storageBadge}</td>
                        <td class="${handicapTypeClass}">${handicapTypeText}</td>
                        <td class="${handicapChangeClass}">${parseFloat(record.handicap_change) > 0 ? 'â†‘ ' : parseFloat(record.handicap_change) < 0 ? 'â†“ ' : ''}${Math.abs(parseFloat(record.handicap_change)).toFixed(2)}</td>
                        <td class="${waterChangeClass}">${parseFloat(record.water_change) > 0 ? 'â†‘ ' : parseFloat(record.water_change) < 0 ? 'â†“ ' : ''}${Math.abs(parseFloat(record.water_change)).toFixed(2)}</td>
                        <td>${record.historical_record === 'win' ? 'èµ¢' : 'è¾“'}</td>
                        <td>${record.recommendation}</td>
                        <td>
                            <select class="actual-result-select" data-id="${record.id}" data-is-local="${isLocal}" style="width: 70px; padding: 6px; font-size: 12px;">
                                <option value="">é€‰æ‹©</option>
                                <option value="win" ${record.actual_result === 'win' ? 'selected' : ''}>èµ¢</option>
                                <option value="loss" ${record.actual_result === 'loss' ? 'selected' : ''}>è¾“</option>
                            </select>
                        </td>
                        <td style="white-space: nowrap;">
                            <button class="record-action record-edit" data-id="${record.id}" data-is-local="${isLocal}">ç¼–è¾‘</button>
                            <button class="record-action record-delete" data-id="${record.id}" data-is-local="${isLocal}">åˆ é™¤</button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                addHistoryEventListeners();
                
                // æ›´æ–°å›¾è¡¨æ•°æ®
                updateChartData(allRecords);
                
            } catch (error) {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
                tableBody.innerHTML = '';
                const errorRow = document.createElement('tr');
                errorRow.innerHTML = `<td colspan="8" style="text-align: center; padding: 30px; font-size: 14px; color: #666;">åŠ è½½å¤±è´¥: ${error.message}</td>`;
                tableBody.appendChild(errorRow);
            }
        }

        function addHistoryEventListeners() {
            // å®é™…ç»“æœé€‰æ‹©
            document.querySelectorAll('.actual-result-select').forEach(select => {
                select.addEventListener('change', function() {
                    const id = this.dataset.id;
                    const isLocal = this.dataset.isLocal === 'true';
                    const value = this.value;
                    
                    if (isLocal) {
                        // æ›´æ–°æœ¬åœ°è®°å½•
                        StorageManager.updateRecordLocal(id, { actual_result: value });
                    } else {
                        // æ›´æ–°æœåŠ¡å™¨è®°å½•
                        APIService.updateRecord(id, { actual_result: value })
                            .then(result => {
                                if (!result.success) {
                                    alert('æ›´æ–°å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                                }
                            })
                            .catch(error => {
                                alert('æ›´æ–°å¤±è´¥: ' + error.message);
                            });
                    }
                    
                    // é‡æ–°åŠ è½½å†å²è®°å½•ä»¥æ›´æ–°å›¾è¡¨
                    loadHistory();
                });
            });
            
            // ç¼–è¾‘è®°å½•
            document.querySelectorAll('.record-edit').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.dataset.id;
                    const isLocal = this.dataset.isLocal === 'true';
                    editRecord(id, isLocal);
                });
            });
            
            // åˆ é™¤è®°å½•
            document.querySelectorAll('.record-delete').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.dataset.id;
                    const isLocal = this.dataset.isLocal === 'true';
                    
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
                        deleteRecord(id, isLocal);
                    }
                });
            });
        }

        function editRecord(id, isLocal) {
            alert('ç¼–è¾‘åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...');
            // è¿™é‡Œå¯ä»¥å®ç°ç¼–è¾‘åŠŸèƒ½
        }

        async function deleteRecord(id, isLocal) {
            try {
                if (isLocal) {
                    // åˆ é™¤æœ¬åœ°è®°å½•
                    StorageManager.deleteRecordLocal(id);
                } else {
                    // åˆ é™¤æœåŠ¡å™¨è®°å½•
                    const result = await APIService.deleteRecord(id);
                    if (!result.success) {
                        throw new Error(result.error || 'åˆ é™¤å¤±è´¥');
                    }
                }
                
                // é‡æ–°åŠ è½½å†å²è®°å½•
                await loadHistory();
                alert('è®°å½•å·²åˆ é™¤ï¼');
                
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        async function syncHistory() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•ä»¥åŒæ­¥æ•°æ®ï¼');
                UserSystem.showLoginModal();
                return;
            }
            
            const localRecords = StorageManager.getLocalRecords();
            
            if (localRecords.length === 0) {
                alert('æ²¡æœ‰éœ€è¦åŒæ­¥çš„æœ¬åœ°è®°å½•ï¼');
                return;
            }
            
            try {
                APIService.showGlobalLoading(`æ­£åœ¨åŒæ­¥ ${localRecords.length} æ¡æœ¬åœ°è®°å½•...`);
                
                let successCount = 0;
                let failCount = 0;
                
                // é€æ¡åŒæ­¥æœ¬åœ°è®°å½•åˆ°æœåŠ¡å™¨
                for (const record of localRecords) {
                    try {
                        // æ·»åŠ ç”¨æˆ·ID
                        record.user_id = currentUser.id;
                        
                        // å°è¯•ä¿å­˜åˆ°æœåŠ¡å™¨
                        const result = await APIService.saveRecord(record);
                        
                        if (result.success) {
                            successCount++;
                            // ä»æœ¬åœ°å­˜å‚¨ä¸­åˆ é™¤å·²åŒæ­¥çš„è®°å½•
                            StorageManager.deleteRecordLocal(record.id);
                        } else {
                            failCount++;
                        }
                    } catch (error) {
                        failCount++;
                    }
                }
                
                APIService.hideGlobalLoading();
                
                // é‡æ–°åŠ è½½å†å²è®°å½•
                await loadHistory();
                
                alert(`åŒæ­¥å®Œæˆï¼\næˆåŠŸ: ${successCount} æ¡\nå¤±è´¥: ${failCount} æ¡`);
                
            } catch (error) {
                APIService.hideGlobalLoading();
                alert('åŒæ­¥å¤±è´¥: ' + error.message);
            }
        }

        // ============== å›¾è¡¨åŠŸèƒ½ ============== //
        let statsChart = null;

        function initChart() {
            const ctx = document.getElementById('stats-chart').getContext('2d');
            const isMobile = window.innerWidth <= 768;
            
            statsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['æ°´ä½ä¸Šå‡', 'æ°´ä½ä¸‹é™', 'ç›˜å£ä¸Šå‡', 'ç›˜å£ä¸‹é™', 'æ°´ä½<0.90'],
                    datasets: [{
                        label: 'èƒœç‡ (%)',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.7)',
                            'rgba(220, 53, 69, 0.7)',
                            'rgba(0, 123, 255, 0.7)',
                            'rgba(255, 193, 7, 0.7)',
                            'rgba(111, 66, 193, 0.7)'
                        ],
                        borderColor: [
                            'rgb(40, 167, 69)',
                            'rgb(220, 53, 69)',
                            'rgb(0, 123, 255)',
                            'rgb(255, 193, 7)',
                            'rgb(111, 66, 193)'
                        ],
                        borderWidth: 1,
                        barPercentage: isMobile ? 0.6 : 0.8,
                        categoryPercentage: isMobile ? 0.7 : 0.9
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                },
                                font: {
                                    size: isMobile ? 10 : 12
                                },
                                padding: 5
                            },
                            title: {
                                display: true,
                                text: 'èƒœç‡ (%)',
                                font: {
                                    size: isMobile ? 12 : 14
                                }
                            },
                            grid: {
                                drawBorder: false
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: isMobile ? 10 : 12
                                },
                                maxRotation: isMobile ? 45 : 0,
                                minRotation: isMobile ? 45 : 0
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.raw + '%';
                                }
                            },
                            titleFont: {
                                size: isMobile ? 12 : 14
                            },
                            bodyFont: {
                                size: isMobile ? 12 : 14
                            },
                            padding: isMobile ? 8 : 12
                        },
                        title: {
                            display: true,
                            text: 'èƒœç‡ç»Ÿè®¡å›¾è¡¨ï¼ˆåŒ…å«è®©çƒç›˜å’Œå¤§å°ç›˜ï¼‰',
                            font: {
                                size: isMobile ? 14 : 16
                            },
                            padding: {
                                top: 10,
                                bottom: 20
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        function updateChartData(records) {
            if (!statsChart) return;
            
            // åªç»Ÿè®¡æœ‰å®é™…ç»“æœçš„è®°å½•
            const validRecords = records.filter(record => record.actual_result);
            
            if (validRecords.length === 0) {
                statsChart.data.datasets[0].data = [0, 0, 0, 0, 0];
                statsChart.update();
                return;
            }
            
            // è®¡ç®—ç»Ÿè®¡
            let waterUpTotal = 0;
            let waterUpWins = 0;
            let waterDownTotal = 0;
            let waterDownWins = 0;
            let handicapUpTotal = 0;
            let handicapUpWins = 0;
            let handicapDownTotal = 0;
            let handicapDownWins = 0;
            let lowWaterTotal = 0;
            let lowWaterWins = 0;

            validRecords.forEach(record => {
                const waterChange = parseFloat(record.water_change) || 0;
                const handicapChange = parseFloat(record.handicap_change) || 0;
                const currentWater = parseFloat(record.current_water) || 0;
                const actualResult = record.actual_result;

                // æ°´ä½å˜åŒ–ç»Ÿè®¡
                if (waterChange > 0) {
                    waterUpTotal++;
                    if (actualResult === 'win') waterUpWins++;
                } else if (waterChange < 0) {
                    waterDownTotal++;
                    if (actualResult === 'win') waterDownWins++;
                }

                // ç›˜å£å˜åŒ–ç»Ÿè®¡
                if (handicapChange > 0) {
                    handicapUpTotal++;
                    if (actualResult === 'win') handicapUpWins++;
                } else if (handicapChange < 0) {
                    handicapDownTotal++;
                    if (actualResult === 'win') handicapDownWins++;
                }

                // å³æ—¶æ°´ä½ä½äº0.90çš„ç»Ÿè®¡
                if (currentWater < 0.90) {
                    lowWaterTotal++;
                    if (actualResult === 'win') lowWaterWins++;
                }
            });

            // è®¡ç®—èƒœç‡
            const waterUpWinRate = waterUpTotal > 0 ? Math.round((waterUpWins / waterUpTotal) * 100) : 0;
            const waterDownWinRate = waterDownTotal > 0 ? Math.round((waterDownWins / waterDownTotal) * 100) : 0;
            const handicapUpWinRate = handicapUpTotal > 0 ? Math.round((handicapUpWins / handicapUpTotal) * 100) : 0;
            const handicapDownWinRate = handicapDownTotal > 0 ? Math.round((handicapDownWins / handicapDownTotal) * 100) : 0;
            const lowWaterWinRate = lowWaterTotal > 0 ? Math.round((lowWaterWins / lowWaterTotal) * 100) : 0;

            // æ›´æ–°å›¾è¡¨
            statsChart.data.datasets[0].data = [waterUpWinRate, waterDownWinRate, handicapUpWinRate, handicapDownWinRate, lowWaterWinRate];
            statsChart.update();
        }

        // ============== å…¶ä»–åŠŸèƒ½å‡½æ•° ============== //
        function resetAsianForm() {
            document.getElementById('asian-match-name').value = '';
            document.getElementById('asian-initial-handicap').value = '';
            document.getElementById('asian-current-handicap').value = '';
            document.getElementById('asian-initial-water').value = '';
            document.getElementById('asian-current-water').value = '';
            document.getElementById('asian-historical-record').value = '';
            document.getElementById('asian-recommendation-result').textContent = 'ç­‰å¾…è¾“å…¥';
            document.getElementById('asian-recommendation-result').className = 'recommendation-result recommendation-neutral';
            document.getElementById('asian-recommendation-details').textContent = 'è¯·å¡«å†™æ‰€æœ‰å­—æ®µä»¥è·å–æ¨èç»“æœ';
            document.getElementById('asian-loading').style.display = 'none';
        }

        function resetSizeForm() {
            document.getElementById('size-match-name').value = '';
            document.getElementById('size-initial-handicap').value = '';
            document.getElementById('size-current-handicap').value = '';
            document.getElementById('size-initial-water').value = '';
            document.getElementById('size-current-water').value = '';
            document.getElementById('size-historical-record').value = '';
            document.getElementById('size-recommendation-result').textContent = 'ç­‰å¾…è¾“å…¥';
            document.getElementById('size-recommendation-result').className = 'recommendation-result size-recommendation-neutral';
            document.getElementById('size-recommendation-details').textContent = 'è¯·å¡«å†™æ‰€æœ‰å­—æ®µä»¥è·å–æ¨èç»“æœ';
            document.getElementById('size-loading').style.display = 'none';
        }

        function toggleHistory() {
            const historyContent = document.getElementById('history-content');
            const toggleButton = document.getElementById('toggle-history');
            
            if (historyContent.classList.contains('hidden')) {
                historyContent.classList.remove('hidden');
                toggleButton.textContent = 'éšè—è®°å½•';
            } else {
                historyContent.classList.add('hidden');
                toggleButton.textContent = 'æ˜¾ç¤ºè®°å½•';
            }
        }

        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                StorageManager.clearLocalRecords();
                
                // è¿™é‡Œä¹Ÿå¯ä»¥æ·»åŠ æ¸…ç©ºæœåŠ¡å™¨è®°å½•çš„ä»£ç 
                // ä½†é€šå¸¸éœ€è¦ç”¨æˆ·ç¡®è®¤ï¼Œå› ä¸ºè¿™æ˜¯å±é™©æ“ä½œ
                
                loadHistory();
                alert('å†å²è®°å½•å·²æ¸…ç©ºï¼');
            }
        }

        // ============== é¡µé¢åŠ è½½å…¥å£ ============== //
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMå†…å®¹åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–åº”ç”¨ç¨‹åº...');
            initializeApplication();
        });
    </script>
</body>

</html>
